//#include "stealer.h"
#include <windows.h>
#include <wlanapi.h>
#include <libxml/parser.h>
#include <libxml/tree.h>
#include <stdio.h>

#define WLAN_API_VERSION_2 2

HANDLE open_wlan_handle(DWORD api_version) {
    
    DWORD negotiatedVersion = 0;
    HANDLE cliendHandle = INVALID_HANDLE_VALUE;

    DWORD result = WlanOpenHandle(api_version, NULL, &negotiatedVersion, &cliendHandle);
    
    if (result != ERROR_SUCCESS) {
        MessageBox(NULL, "Error openning WlanHandle", "Error Popup", MB_OK | MB_ICONWARNING);
        return INVALID_HANDLE_VALUE;
    }

    return cliendHandle;
}

PWLAN_INTERFACE_INFO_LIST enum_wlan_interfaces(HANDLE handle) {

    PWLAN_INTERFACE_INFO_LIST interfaceInfoList = NULL;
    DWORD result = WlanEnumInterfaces(handle, NULL, &interfaceInfoList);

    if (result != ERROR_SUCCESS) {
        MessageBox(NULL, "Error with enumerating interfaces", "Error Popup", MB_OK | MB_ICONWARNING);
        return NULL;
    }

    return interfaceInfoList;
}

PWLAN_PROFILE_INFO_LIST grab_interface_profiles(HANDLE handle, GUID interface_guid) {

    PWLAN_PROFILE_INFO_LIST profileList = NULL;
    DWORD result = WlanGetProfileList(handle, &interface_guid, NULL, &profileList);

    if (result != ERROR_SUCCESS) {
        MessageBox(NULL, "Error grabbing profiles", "Error popup", MB_OK | MB_ICONWARNING);
        return NULL;
    }

    return profileList;
}




int main() {

    HANDLE wlan_handle = open_wlan_handle(WLAN_API_VERSION_2);
        PWLAN_INTERFACE_INFO_LIST interface_ptr = enum_wlan_interfaces(wlan_handle);
        
        for (DWORD i = 0; i < interface_ptr->dwNumberOfItems; ++i) {
            WLAN_INTERFACE_INFO interface_info = interface_ptr->InterfaceInfo[i];
            printf("Desc: %ws\n", interface_info.strInterfaceDescription);

            PWLAN_PROFILE_INFO_LIST profile_list = grab_interface_profiles(wlan_handle, interface_info.InterfaceGuid);
            
            for (DWORD j = 0; j < profile_list->dwNumberOfItems; ++j) {
                WLAN_PROFILE_INFO profile_info = profile_list->ProfileInfo[j];
                printf("Profile flags %lu\n", profile_info.dwFlags);
                printf("Profile name: %ws\n", profile_info.strProfileName);
            }
            WlanFreeMemory(profile_list);
        }

        WlanFreeMemory(interface_ptr);

        WlanCloseHandle(wlan_handle, NULL);

        return EXIT_SUCCESS;
    }
